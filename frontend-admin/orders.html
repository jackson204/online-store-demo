<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å¾Œå° - è¨‚å–®ç®¡ç†</title>

    <!-- Pico.css CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">

    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
        .admin-nav {
            background: var(--primary);
            color: white;
            padding: 1rem 0;
            margin-bottom: 2rem;
        }

        .admin-nav a {
            color: white;
        }

        .admin-nav a:hover {
            opacity: 0.8;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-pending { background: #ffc107; color: #000; }
        .status-processing { background: #17a2b8; color: #fff; }
        .status-shipped { background: #007bff; color: #fff; }
        .status-delivered { background: #28a745; color: #fff; }
        .status-cancelled { background: #dc3545; color: #fff; }

        .actions button {
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
            margin: 0 0.25rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--background-color);
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .order-items {
            margin: 1rem 0;
        }

        .order-items table {
            margin: 0;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- ç®¡ç†å“¡å°èˆªåˆ— -->
        <nav class="admin-nav">
            <div class="container-fluid">
                <ul>
                    <li><strong>ğŸ”§ ç®¡ç†å¾Œå°</strong></li>
                </ul>
                <ul>
                    <li><a href="dashboard.html">å„€è¡¨æ¿</a></li>
                    <li><a href="products.html">å•†å“ç®¡ç†</a></li>
                    <li><a href="orders.html" aria-current="page">è¨‚å–®ç®¡ç†</a></li>
                    <li><a href="#" @click.prevent="logout">ç™»å‡º ({{ currentUser?.name }})</a></li>
                </ul>
            </div>
        </nav>

        <!-- ä¸»è¦å…§å®¹ -->
        <main class="container">
            <div class="toolbar">
                <h1>è¨‚å–®ç®¡ç†</h1>
                <div>
                    <label>
                        ç¯©é¸ç‹€æ…‹ï¼š
                        <select v-model="filterStatus" style="display: inline-block; width: auto;">
                            <option value="">å…¨éƒ¨</option>
                            <option value="Pending">å¾…è™•ç†</option>
                            <option value="Processing">è™•ç†ä¸­</option>
                            <option value="Shipped">å·²å‡ºè²¨</option>
                            <option value="Delivered">å·²é€é”</option>
                            <option value="Cancelled">å·²å–æ¶ˆ</option>
                        </select>
                    </label>
                </div>
            </div>

            <!-- è¨‚å–®åˆ—è¡¨ -->
            <figure>
                <table>
                    <thead>
                        <tr>
                            <th>è¨‚å–®ç·¨è™Ÿ</th>
                            <th>å®¢æˆ¶åç¨±</th>
                            <th>è¯çµ¡é›»è©±</th>
                            <th>é‡‘é¡</th>
                            <th>ç‹€æ…‹</th>
                            <th>å»ºç«‹æ™‚é–“</th>
                            <th style="width: 180px;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-if="filteredOrders.length === 0">
                            <td colspan="7" style="text-align: center;">æš«ç„¡è¨‚å–®</td>
                        </tr>
                        <tr v-for="order in filteredOrders" :key="order.id">
                            <td><strong>#{{ order.id }}</strong></td>
                            <td>{{ order.recipientName }}</td>
                            <td>{{ order.recipientPhone }}</td>
                            <td>NT$ {{ order.totalAmount.toLocaleString() }}</td>
                            <td>
                                <span class="status-badge" :class="getStatusClass(order.status)">
                                    {{ getStatusText(order.status) }}
                                </span>
                            </td>
                            <td>{{ formatDate(order.createdAt) }}</td>
                            <td>
                                <div class="actions">
                                    <button class="secondary" @click="viewOrderDetail(order)">æŸ¥çœ‹</button>
                                    <button @click="updateOrderStatus(order)">æ›´æ–°</button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </figure>
        </main>

        <!-- è¨‚å–®è©³æƒ… Modal -->
        <div class="modal" :class="{ active: showDetailModal }" @click.self="closeDetailModal">
            <div class="modal-content" v-if="selectedOrder">
                <h2>è¨‚å–®è©³æƒ… #{{ selectedOrder.id }}</h2>
                
                <h3>å®¢æˆ¶è³‡è¨Š</h3>
                <ul>
                    <li><strong>æ”¶ä»¶äººï¼š</strong>{{ selectedOrder.recipientName }}</li>
                    <li><strong>é›»è©±ï¼š</strong>{{ selectedOrder.recipientPhone }}</li>
                    <li><strong>åœ°å€ï¼š</strong>{{ selectedOrder.shippingAddress }}</li>
                </ul>

                <h3>è¨‚å–®é …ç›®</h3>
                <div class="order-items">
                    <table>
                        <thead>
                            <tr>
                                <th>å•†å“åç¨±</th>
                                <th>å–®åƒ¹</th>
                                <th>æ•¸é‡</th>
                                <th>å°è¨ˆ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(item, index) in selectedOrder.items" :key="index">
                                <td>{{ item.productName }}</td>
                                <td>NT$ {{ item.unitPrice.toLocaleString() }}</td>
                                <td>{{ item.quantity }}</td>
                                <td>NT$ {{ (item.unitPrice * item.quantity).toLocaleString() }}</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" style="text-align: right;"><strong>ç¸½è¨ˆï¼š</strong></td>
                                <td><strong>NT$ {{ selectedOrder.totalAmount.toLocaleString() }}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <h3>è¨‚å–®ç‹€æ…‹</h3>
                <p>
                    ç›®å‰ç‹€æ…‹ï¼š
                    <span class="status-badge" :class="getStatusClass(selectedOrder.status)">
                        {{ getStatusText(selectedOrder.status) }}
                    </span>
                </p>
                <p><small>å»ºç«‹æ™‚é–“ï¼š{{ formatDate(selectedOrder.createdAt) }}</small></p>

                <button class="secondary" @click="closeDetailModal">é—œé–‰</button>
            </div>
        </div>

        <!-- æ›´æ–°ç‹€æ…‹ Modal -->
        <div class="modal" :class="{ active: showUpdateModal }" @click.self="closeUpdateModal">
            <div class="modal-content" v-if="selectedOrder">
                <h2>æ›´æ–°è¨‚å–®ç‹€æ…‹ #{{ selectedOrder.id }}</h2>
                
                <label>
                    é¸æ“‡æ–°ç‹€æ…‹
                    <select v-model="newStatus">
                        <option value="Pending">å¾…è™•ç†</option>
                        <option value="Processing">è™•ç†ä¸­</option>
                        <option value="Shipped">å·²å‡ºè²¨</option>
                        <option value="Delivered">å·²é€é”</option>
                        <option value="Cancelled">å·²å–æ¶ˆ</option>
                    </select>
                </label>

                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button @click="confirmUpdateStatus" :disabled="loading">
                        {{ loading ? 'æ›´æ–°ä¸­...' : 'ç¢ºèªæ›´æ–°' }}
                    </button>
                    <button class="secondary" @click="closeUpdateModal">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="../frontend-client/js/config.js"></script>
    <script src="../frontend-client/js/mock-api.js"></script>
    <script src="../frontend-client/js/api.js"></script>
    <script src="../frontend-client/js/auth.js"></script>
    <script src="../frontend-client/js/utils.js"></script>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    currentUser: null,
                    orders: [],
                    filterStatus: '',
                    showDetailModal: false,
                    showUpdateModal: false,
                    selectedOrder: null,
                    newStatus: '',
                    loading: false
                };
            },

            computed: {
                filteredOrders() {
                    if (!this.filterStatus) {
                        return this.orders;
                    }
                    return this.orders.filter(order => order.status === this.filterStatus);
                }
            },

            async mounted() {
                // æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™
                this.checkAdminAccess();
                
                // å–å¾—ç•¶å‰ä½¿ç”¨è€…
                this.currentUser = Auth.getCurrentUser();

                // è¼‰å…¥è¨‚å–®åˆ—è¡¨
                await this.loadOrders();
            },

            methods: {
                checkAdminAccess() {
                    if (!Auth.isLoggedIn()) {
                        alert('è«‹å…ˆç™»å…¥');
                        window.location.href = 'index.html';
                        return;
                    }

                    if (!Auth.isAdmin()) {
                        alert('æ‚¨ä¸æ˜¯ç®¡ç†å“¡ï¼Œç„¡æ³•å­˜å–æ­¤é é¢');
                        window.location.href = 'index.html';
                        return;
                    }
                },

                async loadOrders() {
                    try {
                        // å–å¾—æ‰€æœ‰è¨‚å–®ï¼ˆç›´æ¥å¾ mock è³‡æ–™è®€å–ï¼‰
                        this.orders = window.mockAPI.orders.sort((a, b) => 
                            new Date(b.createdAt) - new Date(a.createdAt)
                        );
                    } catch (error) {
                        console.error('è¼‰å…¥è¨‚å–®éŒ¯èª¤:', error);
                        alert('è¼‰å…¥è¨‚å–®å¤±æ•—');
                    }
                },

                viewOrderDetail(order) {
                    this.selectedOrder = order;
                    this.showDetailModal = true;
                },

                closeDetailModal() {
                    this.showDetailModal = false;
                    this.selectedOrder = null;
                },

                updateOrderStatus(order) {
                    this.selectedOrder = order;
                    this.newStatus = order.status;
                    this.showUpdateModal = true;
                },

                closeUpdateModal() {
                    this.showUpdateModal = false;
                    this.selectedOrder = null;
                    this.newStatus = '';
                },

                async confirmUpdateStatus() {
                    try {
                        this.loading = true;

                        // æ›´æ–°è¨‚å–®ç‹€æ…‹
                        const orderIndex = window.mockAPI.orders.findIndex(o => o.id === this.selectedOrder.id);
                        if (orderIndex !== -1) {
                            window.mockAPI.orders[orderIndex].status = this.newStatus;
                            window.mockAPI.orders[orderIndex].updatedAt = new Date().toISOString();
                        }

                        Utils.showToast('è¨‚å–®ç‹€æ…‹å·²æ›´æ–°', 'success');
                        await this.loadOrders();
                        this.closeUpdateModal();
                    } catch (error) {
                        console.error('æ›´æ–°ç‹€æ…‹éŒ¯èª¤:', error);
                        alert('æ›´æ–°ç‹€æ…‹å¤±æ•—');
                    } finally {
                        this.loading = false;
                    }
                },

                formatDate(dateString) {
                    return new Date(dateString).toLocaleString('zh-TW', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                },

                getStatusText(status) {
                    const statusMap = {
                        'Pending': 'å¾…è™•ç†',
                        'Processing': 'è™•ç†ä¸­',
                        'Shipped': 'å·²å‡ºè²¨',
                        'Delivered': 'å·²é€é”',
                        'Cancelled': 'å·²å–æ¶ˆ'
                    };
                    return statusMap[status] || status;
                },

                getStatusClass(status) {
                    return `status-${status.toLowerCase()}`;
                },

                logout() {
                    if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                        Auth.logout();
                        window.location.href = 'index.html';
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
