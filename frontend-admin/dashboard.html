<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å¾Œå° - å„€è¡¨æ¿</title>

    <!-- Pico.css CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">

    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
        .admin-nav {
            background: var(--primary);
            color: white;
            padding: 1rem 0;
            margin-bottom: 2rem;
        }

        .admin-nav a {
            color: white;
        }

        .admin-nav a:hover {
            opacity: 0.8;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-background-color);
            padding: 1.5rem;
            border-radius: 0.5rem;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
            margin: 0.5rem 0;
        }

        .stat-label {
            color: var(--muted-color);
            font-size: 0.9rem;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- ç®¡ç†å“¡å°èˆªåˆ— -->
        <nav class="admin-nav">
            <div class="container-fluid">
                <ul>
                    <li><strong>ğŸ”§ ç®¡ç†å¾Œå°</strong></li>
                </ul>
                <ul>
                    <li><a href="dashboard.html" aria-current="page">å„€è¡¨æ¿</a></li>
                    <li><a href="products.html">å•†å“ç®¡ç†</a></li>
                    <li><a href="orders.html">è¨‚å–®ç®¡ç†</a></li>
                    <li><a href="#" @click.prevent="logout">ç™»å‡º ({{ currentUser?.name }})</a></li>
                </ul>
            </div>
        </nav>

        <!-- ä¸»è¦å…§å®¹ -->
        <main class="container">
            <h1>å„€è¡¨æ¿</h1>

            <!-- çµ±è¨ˆå¡ç‰‡ -->
            <div class="stats-grid">
                <article class="stat-card">
                    <div class="stat-label">ğŸ“¦ å•†å“ç¸½æ•¸</div>
                    <div class="stat-number">{{ stats.totalProducts }}</div>
                </article>

                <article class="stat-card">
                    <div class="stat-label">ğŸ“‹ è¨‚å–®ç¸½æ•¸</div>
                    <div class="stat-number">{{ stats.totalOrders }}</div>
                </article>

                <article class="stat-card">
                    <div class="stat-label">â³ å¾…è™•ç†è¨‚å–®</div>
                    <div class="stat-number">{{ stats.pendingOrders }}</div>
                </article>

                <article class="stat-card">
                    <div class="stat-label">ğŸ’° ç¸½éŠ·å”®é¡</div>
                    <div class="stat-number">{{ formatCurrency(stats.totalRevenue) }}</div>
                </article>
            </div>

            <!-- å¿«é€Ÿæ“ä½œ -->
            <h2>å¿«é€Ÿæ“ä½œ</h2>
            <div class="quick-actions">
                <article>
                    <a href="products.html" role="button">ğŸ“¦ ç®¡ç†å•†å“</a>
                </article>
                <article>
                    <a href="orders.html" role="button" class="secondary">ğŸ“‹ æŸ¥çœ‹è¨‚å–®</a>
                </article>
            </div>

            <!-- æœ€è¿‘è¨‚å–® -->
            <h2>æœ€è¿‘è¨‚å–®</h2>
            <figure>
                <table>
                    <thead>
                        <tr>
                            <th>è¨‚å–®ç·¨è™Ÿ</th>
                            <th>å®¢æˆ¶åç¨±</th>
                            <th>é‡‘é¡</th>
                            <th>ç‹€æ…‹</th>
                            <th>å»ºç«‹æ™‚é–“</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-if="recentOrders.length === 0">
                            <td colspan="5" style="text-align: center;">æš«ç„¡è¨‚å–®</td>
                        </tr>
                        <tr v-for="order in recentOrders" :key="order.id">
                            <td>#{{ order.id }}</td>
                            <td>{{ order.recipientName }}</td>
                            <td>{{ formatCurrency(order.totalAmount) }}</td>
                            <td>
                                <span :class="getStatusClass(order.status)">
                                    {{ getStatusText(order.status) }}
                                </span>
                            </td>
                            <td>{{ formatDate(order.createdAt) }}</td>
                        </tr>
                    </tbody>
                </table>
            </figure>
        </main>
    </div>

    <!-- JavaScript -->
    <script src="../frontend-client/js/config.js"></script>
    <script src="../frontend-client/js/mock-api.js"></script>
    <script src="../frontend-client/js/api.js"></script>
    <script src="../frontend-client/js/auth.js"></script>
    <script src="../frontend-client/js/utils.js"></script>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    currentUser: null,
                    stats: {
                        totalProducts: 0,
                        totalOrders: 0,
                        pendingOrders: 0,
                        totalRevenue: 0
                    },
                    recentOrders: []
                };
            },

            async mounted() {
                // æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™
                this.checkAdminAccess();
                
                // å–å¾—ç•¶å‰ä½¿ç”¨è€…
                this.currentUser = Auth.getCurrentUser();

                // è¼‰å…¥è³‡æ–™
                await this.loadDashboardData();
            },

            methods: {
                checkAdminAccess() {
                    if (!Auth.isLoggedIn()) {
                        alert('è«‹å…ˆç™»å…¥');
                        window.location.href = 'index.html';
                        return;
                    }

                    if (!Auth.isAdmin()) {
                        alert('æ‚¨ä¸æ˜¯ç®¡ç†å“¡ï¼Œç„¡æ³•å­˜å–æ­¤é é¢');
                        window.location.href = 'index.html';
                        return;
                    }
                },

                async loadDashboardData() {
                    try {
                        // å–å¾—å•†å“è³‡æ–™
                        const productsRes = await api.getProducts();
                        if (productsRes.success) {
                            this.stats.totalProducts = productsRes.data.length;
                        }

                        // å–å¾—æ‰€æœ‰è¨‚å–®ï¼ˆé€™è£¡ç”¨ mock è³‡æ–™ï¼‰
                        const allOrders = window.mockAPI.orders;
                        this.stats.totalOrders = allOrders.length;
                        this.stats.pendingOrders = allOrders.filter(o => o.status === 'Pending').length;
                        this.stats.totalRevenue = allOrders.reduce((sum, o) => sum + o.totalAmount, 0);

                        // å–å¾—æœ€è¿‘ 5 ç­†è¨‚å–®
                        this.recentOrders = allOrders
                            .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                            .slice(0, 5);

                    } catch (error) {
                        console.error('è¼‰å…¥è³‡æ–™éŒ¯èª¤:', error);
                    }
                },

                formatCurrency(amount) {
                    return `NT$ ${amount.toLocaleString()}`;
                },

                formatDate(dateString) {
                    return new Date(dateString).toLocaleString('zh-TW', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                },

                getStatusText(status) {
                    const statusMap = {
                        'Pending': 'å¾…è™•ç†',
                        'Processing': 'è™•ç†ä¸­',
                        'Shipped': 'å·²å‡ºè²¨',
                        'Delivered': 'å·²é€é”',
                        'Cancelled': 'å·²å–æ¶ˆ'
                    };
                    return statusMap[status] || status;
                },

                getStatusClass(status) {
                    const classMap = {
                        'Pending': 'badge-warning',
                        'Processing': 'badge-info',
                        'Shipped': 'badge-primary',
                        'Delivered': 'badge-success',
                        'Cancelled': 'badge-danger'
                    };
                    return classMap[status] || '';
                },

                logout() {
                    if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                        Auth.logout();
                        window.location.href = 'index.html';
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
