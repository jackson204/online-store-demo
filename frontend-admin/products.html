<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å¾Œå° - å•†å“ç®¡ç†</title>

    <!-- Pico.css CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">

    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
        .admin-nav {
            background: var(--primary);
            color: white;
            padding: 1rem 0;
            margin-bottom: 2rem;
        }

        .admin-nav a {
            color: white;
        }

        .admin-nav a:hover {
            opacity: 0.8;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .product-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 0.25rem;
        }

        .actions {
            display: flex;
            gap: 0.5rem;
        }

        .actions button {
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
            margin: 0;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--background-color);
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- ç®¡ç†å“¡å°èˆªåˆ— -->
        <nav class="admin-nav">
            <div class="container-fluid">
                <ul>
                    <li><strong>ğŸ”§ ç®¡ç†å¾Œå°</strong></li>
                </ul>
                <ul>
                    <li><a href="dashboard.html">å„€è¡¨æ¿</a></li>
                    <li><a href="products.html" aria-current="page">å•†å“ç®¡ç†</a></li>
                    <li><a href="orders.html">è¨‚å–®ç®¡ç†</a></li>
                    <li><a href="#" @click.prevent="logout">ç™»å‡º ({{ currentUser?.name }})</a></li>
                </ul>
            </div>
        </nav>

        <!-- ä¸»è¦å…§å®¹ -->
        <main class="container">
            <div class="toolbar">
                <h1>å•†å“ç®¡ç†</h1>
                <button @click="openAddModal">â• æ–°å¢å•†å“</button>
            </div>

            <!-- å•†å“åˆ—è¡¨ -->
            <figure>
                <table>
                    <thead>
                        <tr>
                            <th style="width: 80px;">åœ–ç‰‡</th>
                            <th>å•†å“åç¨±</th>
                            <th>åˆ†é¡</th>
                            <th>åƒ¹æ ¼</th>
                            <th>åº«å­˜</th>
                            <th style="width: 180px;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-if="products.length === 0">
                            <td colspan="6" style="text-align: center;">æš«ç„¡å•†å“</td>
                        </tr>
                        <tr v-for="product in products" :key="product.id">
                            <td>
                                <img :src="product.imageUrl" :alt="product.name" class="product-image">
                            </td>
                            <td>
                                <strong>{{ product.name }}</strong><br>
                                <small>{{ product.description?.substring(0, 50) }}...</small>
                            </td>
                            <td>{{ product.category }}</td>
                            <td>NT$ {{ product.price.toLocaleString() }}</td>
                            <td>
                                <span :style="{ color: product.stock < 10 ? 'red' : 'inherit' }">
                                    {{ product.stock }}
                                </span>
                            </td>
                            <td>
                                <div class="actions">
                                    <button class="secondary" @click="openEditModal(product)">ç·¨è¼¯</button>
                                    <button class="contrast" @click="deleteProduct(product.id)">åˆªé™¤</button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </figure>
        </main>

        <!-- æ–°å¢/ç·¨è¼¯å•†å“ Modal -->
        <div class="modal" :class="{ active: showModal }" @click.self="closeModal">
            <div class="modal-content">
                <h2>{{ isEditMode ? 'ç·¨è¼¯å•†å“' : 'æ–°å¢å•†å“' }}</h2>
                
                <form @submit.prevent="saveProduct">
                    <label>
                        å•†å“åç¨±
                        <input type="text" v-model="formData.name" required>
                    </label>

                    <label>
                        å•†å“æè¿°
                        <textarea v-model="formData.description" rows="3" required></textarea>
                    </label>

                    <label>
                        åˆ†é¡
                        <select v-model="formData.category" required>
                            <option value="">è«‹é¸æ“‡åˆ†é¡</option>
                            <option value="é›»å­ç”¢å“">é›»å­ç”¢å“</option>
                            <option value="é›»è…¦é€±é‚Š">é›»è…¦é€±é‚Š</option>
                            <option value="é…ä»¶">é…ä»¶</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </label>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <label>
                            åƒ¹æ ¼ (NT$)
                            <input type="number" v-model.number="formData.price" min="0" required>
                        </label>

                        <label>
                            åº«å­˜
                            <input type="number" v-model.number="formData.stock" min="0" required>
                        </label>
                    </div>

                    <label>
                        åœ–ç‰‡ç¶²å€
                        <input type="url" v-model="formData.imageUrl" placeholder="https://..." required>
                    </label>

                    <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                        <button type="submit" :disabled="loading">
                            {{ loading ? 'å„²å­˜ä¸­...' : 'å„²å­˜' }}
                        </button>
                        <button type="button" class="secondary" @click="closeModal">å–æ¶ˆ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="../frontend-client/js/config.js"></script>
    <script src="../frontend-client/js/mock-api.js"></script>
    <script src="../frontend-client/js/api.js"></script>
    <script src="../frontend-client/js/auth.js"></script>
    <script src="../frontend-client/js/utils.js"></script>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    currentUser: null,
                    products: [],
                    showModal: false,
                    isEditMode: false,
                    loading: false,
                    formData: {
                        id: null,
                        name: '',
                        description: '',
                        price: 0,
                        stock: 0,
                        imageUrl: '',
                        category: ''
                    }
                };
            },

            async mounted() {
                // æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™
                this.checkAdminAccess();
                
                // å–å¾—ç•¶å‰ä½¿ç”¨è€…
                this.currentUser = Auth.getCurrentUser();

                // è¼‰å…¥å•†å“åˆ—è¡¨
                await this.loadProducts();
            },

            methods: {
                checkAdminAccess() {
                    if (!Auth.isLoggedIn()) {
                        alert('è«‹å…ˆç™»å…¥');
                        window.location.href = 'index.html';
                        return;
                    }

                    if (!Auth.isAdmin()) {
                        alert('æ‚¨ä¸æ˜¯ç®¡ç†å“¡ï¼Œç„¡æ³•å­˜å–æ­¤é é¢');
                        window.location.href = 'index.html';
                        return;
                    }
                },

                async loadProducts() {
                    try {
                        const response = await api.getProducts();
                        if (response.success) {
                            this.products = response.data;
                        }
                    } catch (error) {
                        console.error('è¼‰å…¥å•†å“éŒ¯èª¤:', error);
                        alert('è¼‰å…¥å•†å“å¤±æ•—');
                    }
                },

                openAddModal() {
                    this.isEditMode = false;
                    this.resetForm();
                    this.showModal = true;
                },

                openEditModal(product) {
                    this.isEditMode = true;
                    this.formData = { ...product };
                    this.showModal = true;
                },

                closeModal() {
                    this.showModal = false;
                    this.resetForm();
                },

                resetForm() {
                    this.formData = {
                        id: null,
                        name: '',
                        description: '',
                        price: 0,
                        stock: 0,
                        imageUrl: '',
                        category: ''
                    };
                },

                async saveProduct() {
                    try {
                        this.loading = true;

                        if (this.isEditMode) {
                            // ç·¨è¼¯å•†å“
                            const index = window.mockAPI.products.findIndex(p => p.id === this.formData.id);
                            if (index !== -1) {
                                window.mockAPI.products[index] = {
                                    ...this.formData,
                                    updatedAt: new Date().toISOString()
                                };
                                Utils.showToast('å•†å“å·²æ›´æ–°', 'success');
                            }
                        } else {
                            // æ–°å¢å•†å“
                            const newProduct = {
                                ...this.formData,
                                id: window.mockAPI.products.length + 1,
                                createdAt: new Date().toISOString()
                            };
                            window.mockAPI.products.push(newProduct);
                            Utils.showToast('å•†å“å·²æ–°å¢', 'success');
                        }

                        await this.loadProducts();
                        this.closeModal();
                    } catch (error) {
                        console.error('å„²å­˜å•†å“éŒ¯èª¤:', error);
                        alert('å„²å­˜å•†å“å¤±æ•—');
                    } finally {
                        this.loading = false;
                    }
                },

                async deleteProduct(productId) {
                    if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹å•†å“å—ï¼Ÿ')) {
                        return;
                    }

                    try {
                        const index = window.mockAPI.products.findIndex(p => p.id === productId);
                        if (index !== -1) {
                            window.mockAPI.products.splice(index, 1);
                            Utils.showToast('å•†å“å·²åˆªé™¤', 'success');
                            await this.loadProducts();
                        }
                    } catch (error) {
                        console.error('åˆªé™¤å•†å“éŒ¯èª¤:', error);
                        alert('åˆªé™¤å•†å“å¤±æ•—');
                    }
                },

                logout() {
                    if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                        Auth.logout();
                        window.location.href = 'index.html';
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
